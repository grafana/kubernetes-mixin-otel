receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  hostmetrics:
    scrapers:
      cpu:
        metrics:
          system.cpu.logical.count:
            enabled: true
      load: {}
      memory:
        metrics:
          system.memory.limit:
            enabled: true
      disk: {}
      filesystem: {}
      network: {}

  # Scrape simulated kubelet resource metrics from KWOK controller for all nodes
  prometheus/kwok:
    config:
      scrape_configs:
        - job_name: 'kwok-resource-metrics'
          scrape_interval: 30s
          kubernetes_sd_configs:
            - role: node
              kubeconfig_file: /kube/config
          relabel_configs:
            # Extract node name
            - source_labels: [__meta_kubernetes_node_name]
              target_label: node_name
            # Set target to KWOK controller
            - target_label: __address__
              replacement: '${env:KWOK_CONTROLLER_IP}:10247'
            # Build metrics path using node name
            - source_labels: [__meta_kubernetes_node_name]
              target_label: __metrics_path__
              replacement: '/metrics/nodes/$1/metrics/resource'
            # Add k8s_node_name label
            - source_labels: [__meta_kubernetes_node_name]
              target_label: k8s_node_name

  k8s_cluster:
    auth_type: kubeConfig
    collection_interval: 30s
    node_conditions_to_report:
      - Ready
      - MemoryPressure
      - DiskPressure
      - PIDPressure
    allocatable_types_to_report:
      - cpu
      - memory
      - storage
    metadata_collection_interval: 5m

processors:
  k8sattributes:
    auth_type: kubeConfig
    extract:
      otel_annotations: true

  resource/k8sclustername:
    attributes:
      - key: k8s.cluster.name
        action: upsert
        value: ${env:CLUSTER_NAME}

  resourcedetection:
    detectors: [system]
    timeout: 2s
    override: true

  batch: {}

exporters:
  # Send metrics to local LGTM (grafana/otel-lgtm container)
  otlphttp/metrics:
    endpoint: http://host.docker.internal:4318
    tls:
      insecure: true

  # Prometheus debug exporter
  prometheus:
    endpoint: "0.0.0.0:8889"
    resource_to_telemetry_conversion:
      enabled: true

extensions:
  health_check: {}

service:
  extensions: [health_check]

  pipelines:
    metrics:
      receivers: [otlp, hostmetrics, k8s_cluster, prometheus/kwok]
      processors:
        - resourcedetection
        - k8sattributes
        - resource/k8sclustername
        - batch
      exporters: [otlphttp/metrics, prometheus]

